<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="/main.css" rel="stylesheet">
</head>
<body class="grey-bg">
  <%- include('nav.ejs') %>

  <%= JSON.stringify(result) %>
    <div class="detail-bg">
        <div class="chat-screen">
          <div class="chat-box"><span>안녕하세요</span></div>
          <div class="chat-box"><span>안녕하세요</span></div>
          <div class="chat-box mine"><span>안녕하세요</span></div>
        </div>
      </div>
      <div class="chat-form">
        <input class="chat-input">
        <button class="chat-button">전송</button>
      </div> 

    <script src="https://cdn.jsdelivr.net/npm/socket.io@4.7.2/client-dist/socket.io.min.js"></script>

    <script>
      const socket = io()  //유저의 웹소켓 연결
      // socket.emit('age', '10') //('데이터이름', '데이터')
      socket.emit('ask-join', '<%= result._id %>') // 룸에 조인 시켜줘. 서버에 요청

      // console.log('result', JSON.stringify(result[1]));


      // 유저가 특정 룸에 메세지를 보내려면?
      // -> 서버에게 룸에 메세지를 전달하라고 부탁
      // -> 서버는 부탁받으면 룸에 뿌림
      document.querySelector(".chat-button").addEventListener('click', function(){
        let 작성한거 = document.querySelector('.chat-input').value
        socket.emit('message-send', {
          msg: 작성한거,
          room: '<%= result._id %>'
        })
      })

      socket.on('message-broadcast', (data)=>{
        //Todo db 에 저장. 채팅내용, 날짜, 부모, 도큐id...
        document.querySelector('.chat-screen').insertAdjacentHTML(
          'beforeend', `<div class="chat-box"><span>${data}</span></div>`
        )
      })

      //수신
      socket.on('name', (data)=>{
        console.log(data);
      })

      socket.on('broadcast',(data)=>{
        console.log(data);
      })
    </script>
    
    
  </body>
</html>